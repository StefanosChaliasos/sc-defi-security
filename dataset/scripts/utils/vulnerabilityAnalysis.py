import sqlite3

from scripts.utils.colours import ColoredText
from tools import TOOLS

TOOLS.remove("all")
chain = "bsc"

conn = sqlite3.connect('../../database/analysis.db')

print("Tool Findings")
print(ColoredText.info("*"*13))
total_vulnerabilities = 0
taxonomy = dict()
for tool in TOOLS:
    cursor = conn.execute(f"""SELECT f.vulnerability Vulnerability, COUNT(DISTINCT a.address) Total
                                FROM Address AS a 
                                JOIN Result AS r ON r.address_id = a.address_id 
                                JOIN Finding AS f ON f.result_id = r.result_id 
                                WHERE chain='{chain}' and r.tool = "{tool}" GROUP BY f.vulnerability""")
    print(ColoredText.success(tool.upper()))
    total = 0
    for row in cursor:
        print("\t" + str(row[0]) + ": " + str(row[1]))
        total += row[1]
        total_vulnerabilities += row[1]
        if row[0] not in taxonomy:
            taxonomy[row[0]] = row[1]
        else:
            taxonomy[row[0]] = taxonomy[row[0]] + row[1]
    print(ColoredText.warning("\tTotal:" + str(total)))

print()
for k, v in taxonomy.items():
    print(ColoredText.error(k + ": " + str(v)))
print()
print(ColoredText.error("Total:" + str(total_vulnerabilities)))
